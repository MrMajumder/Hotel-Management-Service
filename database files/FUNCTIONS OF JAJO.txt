CREATE OR REPLACE FUNCTION ROOM_SEARCH(RID IN NUMBER, ADATE IN VARCHAR2, DDATE IN VARCHAR2)
RETURN NUMBER IS

NUM NUMBER;
D DATE;
A DATE;
AR DATE;
DD DATE;
 BEGIN
 AR := TO_DATE(ADATE,'YYYY-MM-DD HH24:MI:SS');
 DD := TO_DATE(DDATE,'YYYY-MM-DD HH24:MI:SS');
 NUM := 0;
 FOR R IN (SELECT ARRIVAL_DATE, DEPARTURE_DATE FROM BOOKED_ROOMS WHERE ROOM_ID = RID ORDER BY ARRIVAL_DATE ASC)
 LOOP
		
	A := R.ARRIVAL_DATE;
	
	IF NUM = 0 THEN
		IF DD <= A THEN
			RETURN 1;
		ELSE
			NUM := NUM + 1;
			D := R.DEPARTURE_DATE;
		END IF;
	ELSE
		IF D <= AR AND DD <= A THEN
			RETURN 1;
		ELSE
			D := R.DEPARTURE_DATE;
		END IF;
	END IF;
 END LOOP;

IF AR >= D OR D IS NULL THEN 
	RETURN 1;
ELSE 
	RETURN 0;	
END IF;
END;
/


CREATE OR REPLACE FUNCTION SERVICE_ENTRY(SERVICET IN VARCHAR2, SERVICED IN VARCHAR2, ID IN NUMBER, RID IN NUMBER)
RETURN NUMBER IS 
 EMPID NUMBER;
 COSTT NUMBER;
 B_ID NUMBER;
 
BEGIN 
FOR R IN (SELECT SERVICE_ID FROM SERVICES WHERE SERVICE_TYPE = SERVICET AND USER_ID IS NULL)
	LOOP

	FOR E IN (SELECT USER_ID FROM EMPLOYEE WHERE POSITION = SERVICET AND AVAILABILITY = 0)
	LOOP 

		SELECT BILL_ID INTO B_ID FROM HOTEL_BILL WHERE RESERVATION_ID = (SELECT DISTINCT RO.RESERVATION_ID FROM ROOM RO, RESERVATION RE WHERE RO.RESERVATION_ID = RE.RESERVATION_ID AND RO.ROOM_ID = RID AND RE.USER_ID = ID);

		UPDATE SERVICES SET USER_ID = E.USER_ID, DESCRIPTION = SERVICED WHERE SERVICE_ID = R.SERVICE_ID;
		UPDATE EMPLOYEE SET AVAILABILITY = 1 WHERE USER_ID = E.USER_ID;
		SELECT COST INTO COSTT FROM SERVICES WHERE SERVICE_ID = R.SERVICE_ID;
		UPDATE BILL SET COST = (COST + COSTT) WHERE BILL_ID = B_ID;
		UPDATE HOTEL_BILL SET DUE = DUE + COSTT WHERE BILL_ID = B_ID;
		INSERT INTO ROOM_HB_SERV_RECEIVES VALUES (R.SERVICE_ID, RID, B_ID, 1, ACT_ID.NEXTVAL, SYSDATE, E.USER_ID);
		RETURN 1;
	END LOOP;
END LOOP;
	RETURN 0;
EXCEPTION
WHEN NO_DATA_FOUND THEN
 RETURN 2;
END;
/

-- SELECT DISTINCT RO.RESERVATION_ID FROM ROOM RO, RESERVATION RE WHERE (RO.ROOM_ID = 1 AND RE.USER_ID = 2);
-- 
-- 
-- BEGIN
-- 	DBMS_OUTPUT.PUT_LINE(SERVICE_ENTRY('Food Service', 'FFSDF', 1, 1));
-- END;
-- /
-- UPDATE EMPLOYEE SET AVAILABILITY = 0 WHERE USER_ID = 11;
-- 





-- CREATE OR REPLACE FUNCTION ROOM_SEARCH(RID IN NUMBER, ADATE IN VARCHAR2, DDATE IN VARCHAR2)
-- RETURN NUMBER IS
-- 
-- NUM NUMBER;
-- D DATE;
-- A DATE;
-- AR DATE;
-- DD DATE;
--  BEGIN
--  AR := TO_DATE(ADATE,'YYYY-MM-DD');
--  DD := TO_DATE(DDATE,'YYYY-MM-DD');
--  FOR R IN (SELECT COUNT(*) C, ARRIVAL_DATE, DEPARTURE_DATE FROM BOOKED_ROOMS WHERE ROOM_ID = RID ORDER BY ARRIVAL_DATE ASC)
--  LOOP
--  D := TO_DATE(R.DEPARTURE_DATE,'YYYY-MM-DD');
--  A := TO_DATE(R.ARRIVAL_DATE,'YYYY-MM-DD');
-- 	IF R.C = 0 THEN 
-- 		RETURN 1;
-- 	ELSIF R.C = 1 THEN 
-- 		IF D <= AR THEN 
-- 		RETURN 1;
-- 		END IF;
-- 	ELSE 
-- 		IF NUM = 0 THEN
-- 			D := D;
-- 			NUM := NUM + 1;
-- 		ELSE
-- 			IF D <= AR AND  DD <= A THEN
-- 				RETURN 1;
-- 			ELSE
-- 				D := A;
-- 				NUM := NUM + 1;
-- 			END IF;
-- 		END IF;
-- 	END IF;
-- END LOOP;
-- IF D <= AR THEN 
-- RETURN 1;
-- ELSE 
-- RETURN 0;	
-- END IF;
-- END;
-- /
-- 




